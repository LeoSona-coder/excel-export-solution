# ğŸš€ ä»é›¶åˆ°ä¸€ï¼šç™¾ä¸‡çº§æ•°æ®Excelå¯¼å‡ºæŠ€æœ¯æ–¹æ¡ˆå®è·µ

> æœ¬æ–‡å°†æ‰‹æŠŠæ‰‹æ•™ä½ å¦‚ä½•å®ç°ä¸€ä¸ªé«˜æ€§èƒ½çš„Excelå¯¼å‡ºæŠ€æœ¯æ–¹æ¡ˆï¼Œæ”¯æŒç™¾ä¸‡çº§æ•°æ®å¯¼å‡ºè€Œä¸ä¼šå†…å­˜æº¢å‡ºã€‚æˆ‘ä»¬å°†ä»ä¼ ç»Ÿæ–¹æ¡ˆçš„é—®é¢˜å¼€å§‹ï¼Œé€æ­¥ä¼˜åŒ–åˆ°æœ€ç»ˆçš„æµå¼å¤„ç†æ–¹æ¡ˆï¼Œå¸®åŠ©å¤§å®¶å­¦ä¹ å¤§æ•°æ®å¤„ç†çš„æœ€ä½³å®è·µã€‚

## ğŸ“– å‰è¨€

åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼ŒExcelå¯¼å‡ºæ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„éœ€æ±‚ã€‚ä½†æ˜¯å½“æ•°æ®é‡è¾¾åˆ°ç™¾ä¸‡çº§åˆ«æ—¶ï¼Œä¼ ç»Ÿçš„å¯¼å‡ºæ–¹æ¡ˆå¾€å¾€ä¼šé‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š

- **å†…å­˜æº¢å‡º**ï¼šä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®åˆ°å†…å­˜
- **å“åº”è¶…æ—¶**ï¼šç”¨æˆ·ç­‰å¾…æ—¶é—´è¿‡é•¿
- **ç³»ç»Ÿå¡é¡¿**ï¼šå ç”¨å¤§é‡ç³»ç»Ÿèµ„æº
- **å¹¶å‘é—®é¢˜**ï¼šå¤šç”¨æˆ·åŒæ—¶å¯¼å‡ºæ—¶ç³»ç»Ÿå´©æºƒ

æœ¬æ–‡å°†é€šè¿‡å®Œæ•´çš„æŠ€æœ¯æ–¹æ¡ˆå’Œå®é™…ä»£ç æ¼”ç¤ºï¼Œæ•™ä½ å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜ï¼Œé€‚åˆå­¦ä¹ å¤§æ•°æ®å¤„ç†çš„æœ€ä½³å®è·µã€‚

## ğŸ¯ æŠ€æœ¯é€‰å‹

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç¡®å®šæŠ€æœ¯æ ˆï¼š

- **Spring Boot 2.7+**ï¼šæä¾›å¼ºå¤§çš„ä¼ä¸šçº§åŠŸèƒ½
- **MyBatis**ï¼šçµæ´»çš„SQLæ˜ å°„æ¡†æ¶
- **EasyExcel**ï¼šé˜¿é‡Œå¼€æºçš„Excelå¤„ç†æ¡†æ¶
- **Redis**ï¼šç¼“å­˜ä»»åŠ¡çŠ¶æ€ï¼Œæå‡æ€§èƒ½
- **MySQL**ï¼šæ•°æ®å­˜å‚¨

## ğŸ—ï¸ é¡¹ç›®æ­å»º

### 1. åˆ›å»ºSpring Booté¡¹ç›®

é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„Spring Booté¡¹ç›®ï¼Œ`pom.xml`é…ç½®å¦‚ä¸‹ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.7.0</version>
        <relativePath/>
    </parent>
    
    <groupId>com.example</groupId>
    <artifactId>excel-export-system</artifactId>
    <version>1.0.0</version>
    <name>excel-export-system</name>
    <description>é«˜æ€§èƒ½Excelå¯¼å‡ºç³»ç»Ÿ</description>
    
    <properties>
        <java.version>8</java.version>
    </properties>
    
    <dependencies>
        <!-- Spring Boot Starter -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <!-- MyBatis -->
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
            <version>2.2.2</version>
        </dependency>
        
        <!-- MySQL -->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope>
        </dependency>
        
        <!-- Redis -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        
        <!-- EasyExcel -->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>easyexcel</artifactId>
            <version>3.1.1</version>
        </dependency>
        
        <!-- å…¶ä»–ä¾èµ– -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
</project>
```

### 2. æ•°æ®åº“è®¾è®¡

æˆ‘ä»¬éœ€è¦ä¸¤å¼ è¡¨ï¼šç”¨æˆ·è¡¨å’Œå¯¼å‡ºä»»åŠ¡è¡¨ã€‚

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL COMMENT 'ç”¨æˆ·å',
  `email` varchar(100) DEFAULT NULL COMMENT 'é‚®ç®±',
  `phone` varchar(20) DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  `department` varchar(50) DEFAULT NULL COMMENT 'éƒ¨é—¨',
  `position` varchar(50) DEFAULT NULL COMMENT 'èŒä½',
  `salary` decimal(10,2) DEFAULT NULL COMMENT 'è–ªèµ„',
  `hire_date` date DEFAULT NULL COMMENT 'å…¥èŒæ—¥æœŸ',
  `status` tinyint DEFAULT '1' COMMENT 'çŠ¶æ€ï¼š1-åœ¨èŒï¼Œ0-ç¦»èŒ',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_username` (`username`),
  KEY `idx_department` (`department`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- å¯¼å‡ºä»»åŠ¡è¡¨
CREATE TABLE `export_task` (
  `id` varchar(32) NOT NULL COMMENT 'ä»»åŠ¡ID',
  `task_name` varchar(100) NOT NULL COMMENT 'ä»»åŠ¡åç§°',
  `export_type` varchar(20) NOT NULL COMMENT 'å¯¼å‡ºç±»å‹',
  `status` varchar(20) NOT NULL COMMENT 'ä»»åŠ¡çŠ¶æ€',
  `total_count` int DEFAULT '0' COMMENT 'æ€»è®°å½•æ•°',
  `processed_count` int DEFAULT '0' COMMENT 'å·²å¤„ç†è®°å½•æ•°',
  `file_name` varchar(200) DEFAULT NULL COMMENT 'æ–‡ä»¶å',
  `file_path` varchar(500) DEFAULT NULL COMMENT 'æ–‡ä»¶è·¯å¾„',
  `file_size` bigint DEFAULT '0' COMMENT 'æ–‡ä»¶å¤§å°',
  `start_time` datetime DEFAULT NULL COMMENT 'å¼€å§‹æ—¶é—´',
  `end_time` datetime DEFAULT NULL COMMENT 'ç»“æŸæ—¶é—´',
  `error_message` text COMMENT 'é”™è¯¯ä¿¡æ¯',
  `create_by` varchar(50) DEFAULT NULL COMMENT 'åˆ›å»ºäºº',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_create_by` (`create_by`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## ğŸ”¥ æ ¸å¿ƒå®ç°

### 1. ä¼ ç»Ÿæ–¹æ¡ˆçš„é—®é¢˜

è®©æˆ‘ä»¬å…ˆçœ‹çœ‹ä¼ ç»Ÿçš„å¯¼å‡ºæ–¹æ¡ˆï¼š

```java
@Service
public class TraditionalExportService {
    
    @Autowired
    private UserMapper userMapper;
    
    /**
     * ä¼ ç»Ÿå¯¼å‡ºæ–¹æ¡ˆ - ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®
     * é—®é¢˜ï¼šå½“æ•°æ®é‡å¤§æ—¶ä¼šå¯¼è‡´å†…å­˜æº¢å‡º
     */
    public void exportTraditional(ExportRequest request) {
        // âŒ ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰æ•°æ®
        List<User> allUsers = userMapper.selectAll();
        
        // âŒ ä¸€æ¬¡æ€§å†™å…¥Excel
        String fileName = "users_" + System.currentTimeMillis() + ".xlsx";
        EasyExcel.write(fileName, User.class)
                .sheet("ç”¨æˆ·æ•°æ®")
                .doWrite(allUsers);
    }
}
```

**é—®é¢˜åˆ†æï¼š**
- å½“ç”¨æˆ·è¡¨æœ‰100ä¸‡æ¡æ•°æ®æ—¶ï¼Œ`selectAll()`ä¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜
- å‡è®¾æ¯æ¡ç”¨æˆ·è®°å½•å ç”¨1KBå†…å­˜ï¼Œ100ä¸‡æ¡å°±æ˜¯1GBå†…å­˜
- åŠ ä¸ŠJVMå¯¹è±¡å¼€é”€ï¼Œå®é™…å†…å­˜å ç”¨å¯èƒ½è¾¾åˆ°2-3GB
- è¿™å¾ˆå®¹æ˜“å¯¼è‡´`OutOfMemoryError`

### 2. æµå¼å¤„ç†æ–¹æ¡ˆ

ç°åœ¨æˆ‘ä»¬æ¥å®ç°ä¼˜åŒ–åçš„æµå¼å¤„ç†æ–¹æ¡ˆï¼š

#### 2.1 å®ä½“ç±»è®¾è®¡

```java
@Data
public class User {
    @ExcelProperty("ç”¨æˆ·ID")
    private Long id;
    
    @ExcelProperty("ç”¨æˆ·å")
    private String username;
    
    @ExcelProperty("é‚®ç®±")
    private String email;
    
    @ExcelProperty("æ‰‹æœºå·")
    private String phone;
    
    @ExcelProperty("éƒ¨é—¨")
    private String department;
    
    @ExcelProperty("èŒä½")
    private String position;
    
    @ExcelProperty("è–ªèµ„")
    private BigDecimal salary;
    
    @ExcelProperty("å…¥èŒæ—¥æœŸ")
    private Date hireDate;
    
    @ExcelProperty("çŠ¶æ€")
    private String statusText;
}

@Data
public class ExportTask {
    private String id;
    private String taskName;
    private String exportType;
    private String status;
    private Integer totalCount;
    private Integer processedCount;
    private String fileName;
    private String filePath;
    private Long fileSize;
    private Date startTime;
    private Date endTime;
    private String errorMessage;
    private String createBy;
    private Date createTime;
}
```

#### 2.2 æ•°æ®è®¿é—®å±‚

```java
@Mapper
public interface UserMapper {
    
    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·æ•°æ®
     * @param offset åç§»é‡
     * @param limit æ¯é¡µå¤§å°
     * @param request æŸ¥è¯¢æ¡ä»¶
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    List<User> selectByPage(@Param("offset") int offset, 
                           @Param("limit") int limit,
                           @Param("request") ExportRequest request);
    
    /**
     * ç»Ÿè®¡æ€»è®°å½•æ•°
     * @param request æŸ¥è¯¢æ¡ä»¶
     * @return æ€»è®°å½•æ•°
     */
    int countTotal(@Param("request") ExportRequest request);
}
```

å¯¹åº”çš„XMLæ˜ å°„ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.excel.mapper.UserMapper">
    
    <select id="selectByPage" resultType="com.example.excel.entity.User">
        SELECT 
            id,
            username,
            email,
            phone,
            department,
            position,
            salary,
            hire_date as hireDate,
            CASE status WHEN 1 THEN 'åœ¨èŒ' ELSE 'ç¦»èŒ' END as statusText
        FROM user
        <where>
            <if test="request.username != null and request.username != ''">
                AND username LIKE CONCAT('%', #{request.username}, '%')
            </if>
            <if test="request.department != null and request.department != ''">
                AND department = #{request.department}
            </if>
            <if test="request.startTime != null">
                AND create_time >= #{request.startTime}
            </if>
            <if test="request.endTime != null">
                AND create_time <= #{request.endTime}
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <select id="countTotal" resultType="int">
        SELECT COUNT(*)
        FROM user
        <where>
            <if test="request.username != null and request.username != ''">
                AND username LIKE CONCAT('%', #{request.username}, '%')
            </if>
            <if test="request.department != null and request.department != ''">
                AND department = #{request.department}
            </if>
            <if test="request.startTime != null">
                AND create_time >= #{request.startTime}
            </if>
            <if test="request.endTime != null">
                AND create_time <= #{request.endTime}
            </if>
        </where>
    </select>
</mapper>
```

#### 2.3 æ ¸å¿ƒå¯¼å‡ºæœåŠ¡

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒï¼Œæˆ‘ä»¬æ¥è¯¦ç»†åˆ†æï¼š

```java
@Service
@Slf4j
public class ExcelExportService {
    
    @Autowired
    private UserMapper userMapper;
    
    @Autowired
    private ExportTaskMapper exportTaskMapper;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // æ‰¹å¤„ç†å¤§å°
    private static final int BATCH_SIZE = 10000;
    
    /**
     * å¯åŠ¨å¯¼å‡ºä»»åŠ¡
     */
    public ExportResponse startExport(ExportRequest request) {
        // 1. ç”Ÿæˆä»»åŠ¡ID
        String taskId = UUID.randomUUID().toString().replace("-", "");
        
        // 2. ç»Ÿè®¡æ€»è®°å½•æ•°
        int totalCount = userMapper.countTotal(request);
        
        // 3. åˆ›å»ºä»»åŠ¡è®°å½•
        ExportTask task = new ExportTask();
        task.setId(taskId);
        task.setTaskName(request.getTaskName());
        task.setExportType(request.getExportType());
        task.setStatus("PENDING");
        task.setTotalCount(totalCount);
        task.setProcessedCount(0);
        task.setCreateBy(request.getCreateBy());
        task.setCreateTime(new Date());
        
        // 4. ä¿å­˜ä»»åŠ¡åˆ°æ•°æ®åº“å’ŒRedis
        exportTaskMapper.insert(task);
        redisTemplate.opsForValue().set("export_task:" + taskId, task, 24, TimeUnit.HOURS);
        
        // 5. å¼‚æ­¥æ‰§è¡Œå¯¼å‡º
        if (request.isAsync()) {
            CompletableFuture.runAsync(() -> doExport(taskId, request));
        } else {
            doExport(taskId, request);
        }
        
        return new ExportResponse(taskId, task);
    }
    
    /**
     * æ‰§è¡Œå¯¼å‡º - æ ¸å¿ƒæ–¹æ³•
     */
    private void doExport(String taskId, ExportRequest request) {
        MemoryMonitor memoryMonitor = new MemoryMonitor();
        
        try {
            // å¯åŠ¨å†…å­˜ç›‘æ§
            memoryMonitor.startMonitoring();
            
            // 1. æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤„ç†ä¸­
            updateTaskStatus(taskId, "PROCESSING", null);
            
            // 2. ç”Ÿæˆæ–‡ä»¶åå’Œè·¯å¾„
            String fileName = generateFileName(request);
            String filePath = "/tmp/excel/" + fileName;
            
            // 3. è·å–æ€»è®°å½•æ•°
            int totalCount = userMapper.countTotal(request);
            
            // 4. åˆ›å»ºExcelå†™å…¥å™¨
            ExcelWriter excelWriter = EasyExcel.write(filePath, User.class).build();
            WriteSheet writeSheet = EasyExcel.writerSheet("ç”¨æˆ·æ•°æ®").build();
            
            int processedCount = 0;
            int currentPage = 0;
            
            // 5. åˆ†æ‰¹å¤„ç†æ•°æ®
            while (processedCount < totalCount) {
                int offset = currentPage * BATCH_SIZE;
                
                // åˆ†é¡µæŸ¥è¯¢æ•°æ®
                List<User> users = userMapper.selectByPage(offset, BATCH_SIZE, request);
                
                if (users.isEmpty()) {
                    break;
                }
                
                // å†™å…¥Excel
                excelWriter.write(users, writeSheet);
                
                // æ›´æ–°è¿›åº¦
                processedCount += users.size();
                updateProgress(taskId, processedCount, totalCount);
                
                currentPage++;
                
                // æ™ºèƒ½å†…å­˜ç®¡ç†
                if (currentPage % 20 == 0) {
                    manageMemory();
                }
                
                log.info("ä»»åŠ¡[{}] å·²å¤„ç† {}/{} æ¡è®°å½•", taskId, processedCount, totalCount);
            }
            
            // 6. å…³é—­å†™å…¥å™¨
            excelWriter.finish();
            
            // 7. è·å–æ–‡ä»¶å¤§å°
            File file = new File(filePath);
            long fileSize = file.length();
            
            // 8. æ›´æ–°ä»»åŠ¡å®ŒæˆçŠ¶æ€
            updateTaskComplete(taskId, fileName, filePath, fileSize);
            
            log.info("ä»»åŠ¡[{}] å¯¼å‡ºå®Œæˆï¼Œæ–‡ä»¶å¤§å°: {} bytes", taskId, fileSize);
            
        } catch (Exception e) {
            log.error("ä»»åŠ¡[{}] å¯¼å‡ºå¤±è´¥", taskId, e);
            updateTaskStatus(taskId, "FAILED", e.getMessage());
        } finally {
            // åœæ­¢å†…å­˜ç›‘æ§å¹¶è®°å½•ç»Ÿè®¡ä¿¡æ¯
            memoryMonitor.stopMonitoring();
            MemoryMonitor.MemoryStats stats = memoryMonitor.getMemoryStats();
            log.info("ä»»åŠ¡[{}] å†…å­˜ç»Ÿè®¡ - å¼€å§‹: {}MB, å³°å€¼: {}MB, å¢é•¿: {}MB", 
                    taskId, stats.getStartMemoryMB(), stats.getPeakMemoryMB(), stats.getMemoryIncreaseMB());
        }
    }
    
    /**
     * æ™ºèƒ½å†…å­˜ç®¡ç†
     */
    private void manageMemory() {
        Runtime runtime = Runtime.getRuntime();
        long totalMemory = runtime.totalMemory();
        long freeMemory = runtime.freeMemory();
        long usedMemory = totalMemory - freeMemory;
        double usagePercent = (double) usedMemory / totalMemory * 100;
        
        // å½“å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡75%æ—¶ï¼Œè§¦å‘GC
        if (usagePercent > 75) {
            log.info("å†…å­˜ä½¿ç”¨ç‡: {:.2f}%, è§¦å‘åƒåœ¾å›æ”¶", usagePercent);
            System.gc();
            
            // è®°å½•GCåçš„å†…å­˜çŠ¶æ€
            long afterGcUsed = runtime.totalMemory() - runtime.freeMemory();
            log.info("GCåå†…å­˜ä½¿ç”¨: {:.2f}MB", afterGcUsed / 1024.0 / 1024.0);
        }
    }
    
    /**
     * æ›´æ–°ä»»åŠ¡è¿›åº¦
     */
    private void updateProgress(String taskId, int processedCount, int totalCount) {
        // æ›´æ–°æ•°æ®åº“
        exportTaskMapper.updateProgress(taskId, processedCount);
        
        // æ›´æ–°Redisç¼“å­˜
        ExportTask task = (ExportTask) redisTemplate.opsForValue().get("export_task:" + taskId);
        if (task != null) {
            task.setProcessedCount(processedCount);
            redisTemplate.opsForValue().set("export_task:" + taskId, task, 24, TimeUnit.HOURS);
        }
    }
    
    // å…¶ä»–è¾…åŠ©æ–¹æ³•...
}
```

### 3. å†…å­˜ç›‘æ§å·¥å…·

ä¸ºäº†æ›´å¥½åœ°ç›‘æ§å¯¼å‡ºè¿‡ç¨‹ä¸­çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå†…å­˜ç›‘æ§å·¥å…·ï¼š

```java
@Slf4j
public class MemoryMonitor {
    private volatile boolean monitoring = false;
    private long startMemory;
    private long peakMemory;
    private long endMemory;
    private ScheduledExecutorService scheduler;
    
    /**
     * å¼€å§‹ç›‘æ§
     */
    public void startMonitoring() {
        this.monitoring = true;
        this.startMemory = getUsedMemory();
        this.peakMemory = this.startMemory;
        
        // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡å†…å­˜ä½¿ç”¨æƒ…å†µ
        this.scheduler = Executors.newSingleThreadScheduledExecutor();
        scheduler.scheduleAtFixedRate(() -> {
            if (monitoring) {
                long currentMemory = getUsedMemory();
                if (currentMemory > peakMemory) {
                    peakMemory = currentMemory;
                }
            }
        }, 0, 1, TimeUnit.SECONDS);
        
        log.info("å†…å­˜ç›‘æ§å·²å¯åŠ¨ï¼Œåˆå§‹å†…å­˜: {:.2f}MB", startMemory / 1024.0 / 1024.0);
    }
    
    /**
     * åœæ­¢ç›‘æ§
     */
    public void stopMonitoring() {
        this.monitoring = false;
        this.endMemory = getUsedMemory();
        
        if (scheduler != null) {
            scheduler.shutdown();
        }
        
        log.info("å†…å­˜ç›‘æ§å·²åœæ­¢ï¼Œç»“æŸå†…å­˜: {:.2f}MB", endMemory / 1024.0 / 1024.0);
    }
    
    /**
     * è·å–å½“å‰å·²ä½¿ç”¨å†…å­˜
     */
    private long getUsedMemory() {
        Runtime runtime = Runtime.getRuntime();
        return runtime.totalMemory() - runtime.freeMemory();
    }
    
    /**
     * è·å–å†…å­˜ç»Ÿè®¡ä¿¡æ¯
     */
    public MemoryStats getMemoryStats() {
        return new MemoryStats(startMemory, peakMemory, endMemory);
    }
    
    @Data
    @AllArgsConstructor
    public static class MemoryStats {
        private long startMemory;
        private long peakMemory;
        private long endMemory;
        
        public double getStartMemoryMB() {
            return startMemory / 1024.0 / 1024.0;
        }
        
        public double getPeakMemoryMB() {
            return peakMemory / 1024.0 / 1024.0;
        }
        
        public double getEndMemoryMB() {
            return endMemory / 1024.0 / 1024.0;
        }
        
        public double getMemoryIncreaseMB() {
            return (peakMemory - startMemory) / 1024.0 / 1024.0;
        }
    }
}
```

## ğŸ¨ å‰ç«¯å®ç°

### 1. ä¸»é¡µé¢è®¾è®¡

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelå¯¼å‡ºç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .form-container {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Excelå¯¼å‡ºç³»ç»Ÿ</h1>
            <p>æ”¯æŒç™¾ä¸‡çº§æ•°æ®é«˜æ€§èƒ½å¯¼å‡º</p>
        </div>
        
        <div class="form-container">
            <form id="exportForm">
                <div class="form-group">
                    <label for="taskName">ä»»åŠ¡åç§°</label>
                    <input type="text" id="taskName" name="taskName" 
                           placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°" required>
                </div>
                
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" name="username" 
                           placeholder="å¯é€‰ï¼Œç­›é€‰ç‰¹å®šç”¨æˆ·">
                </div>
                
                <div class="form-group">
                    <label for="department">éƒ¨é—¨</label>
                    <select id="department" name="department">
                        <option value="">å…¨éƒ¨éƒ¨é—¨</option>
                        <option value="æŠ€æœ¯éƒ¨">æŠ€æœ¯éƒ¨</option>
                        <option value="äº§å“éƒ¨">äº§å“éƒ¨</option>
                        <option value="è¿è¥éƒ¨">è¿è¥éƒ¨</option>
                        <option value="å¸‚åœºéƒ¨">å¸‚åœºéƒ¨</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="async">å¯¼å‡ºæ¨¡å¼</label>
                    <select id="async" name="async">
                        <option value="true">å¼‚æ­¥å¯¼å‡ºï¼ˆæ¨èï¼‰</option>
                        <option value="false">åŒæ­¥å¯¼å‡º</option>
                    </select>
                </div>
                
                <button type="submit" class="btn">ğŸš€ å¼€å§‹å¯¼å‡º</button>
                <a href="/monitor.html" class="btn" style="text-decoration: none;">ğŸ“Š æ€§èƒ½ç›‘æ§</a>
                <a href="/performance.html" class="btn" style="text-decoration: none;">âš¡ æ€§èƒ½å¯¹æ¯”</a>
            </form>
            
            <div class="progress-container" id="progressContainer">
                <h3>å¯¼å‡ºè¿›åº¦</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText">å‡†å¤‡ä¸­...</p>
            </div>
        </div>
    </div>
    
    <script>
        let currentTaskId = null;
        let progressInterval = null;
        
        document.getElementById('exportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const request = {
                taskName: formData.get('taskName'),
                exportType: 'user',
                username: formData.get('username'),
                department: formData.get('department'),
                async: formData.get('async') === 'true',
                createBy: 'admin'
            };
            
            try {
                const response = await fetch('/api/export/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(request)
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    currentTaskId = result.data.taskId;
                    showProgress();
                    startProgressPolling();
                } else {
                    alert('å¯¼å‡ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        });
        
        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
        }
        
        function startProgressPolling() {
            progressInterval = setInterval(async () => {
                if (!currentTaskId) return;
                
                try {
                    const response = await fetch(`/api/export/status/${currentTaskId}`);
                    const result = await response.json();
                    
                    if (result.code === 200) {
                        const task = result.data;
                        updateProgress(task);
                        
                        if (task.status === 'SUCCESS' || task.status === 'FAILED') {
                            clearInterval(progressInterval);
                            
                            if (task.status === 'SUCCESS') {
                                showDownloadLink(task);
                            }
                        }
                    }
                } catch (error) {
                    console.error('è·å–è¿›åº¦å¤±è´¥:', error);
                }
            }, 1000);
        }
        
        function updateProgress(task) {
            const progress = task.totalCount > 0 ? 
                (task.processedCount / task.totalCount * 100) : 0;
            
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `${task.status} - ${task.processedCount}/${task.totalCount} (${progress.toFixed(1)}%)`;
        }
        
        function showDownloadLink(task) {
            const progressText = document.getElementById('progressText');
            progressText.innerHTML = `
                å¯¼å‡ºå®Œæˆï¼æ–‡ä»¶å¤§å°: ${(task.fileSize / 1024 / 1024).toFixed(2)}MB<br>
                <a href="/api/export/download/${task.taskId}" 
                   style="color: #667eea; text-decoration: none; font-weight: bold;">
                   ğŸ“¥ ç‚¹å‡»ä¸‹è½½
                </a>
            `;
        }
    </script>
</body>
</html>
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”åˆ†æ

### 1. ä¼ ç»Ÿæ–¹æ¡ˆ vs æµå¼æ–¹æ¡ˆ

æˆ‘ä»¬æ¥åšä¸€ä¸ªè¯¦ç»†çš„æ€§èƒ½å¯¹æ¯”ï¼š

```java
@RestController
@RequestMapping("/api/performance")
public class PerformanceController {
    
    @Autowired
    private ExcelExportService optimizedService;
    
    @Autowired
    private TraditionalExportService traditionalService;
    
    @PostMapping("/compare")
    public ResponseEntity<Map<String, Object>> comparePerformance(
            @RequestBody ExportRequest request) {
        
        Map<String, Object> result = new HashMap<>();
        
        // æµ‹è¯•ä¼˜åŒ–æ–¹æ¡ˆ
        Map<String, Object> optimizedResult = testOptimizedExport(request);
        
        // ç¯å¢ƒæ¸…ç†
        cleanupEnvironment();
        
        // ç­‰å¾…2ç§’ï¼Œç¡®ä¿ç¯å¢ƒç¨³å®š
        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        // æµ‹è¯•ä¼ ç»Ÿæ–¹æ¡ˆ
        Map<String, Object> traditionalResult = testTraditionalExport(request);
        
        result.put("optimized", optimizedResult);
        result.put("traditional", traditionalResult);
        result.put("comparison", generateComparison(optimizedResult, traditionalResult));
        
        return ResponseEntity.ok(result);
    }
    
    private Map<String, Object> testOptimizedExport(ExportRequest request) {
        MemoryMonitor testMemoryMonitor = new MemoryMonitor();
        Map<String, Object> result = new HashMap<>();
        
        try {
            testMemoryMonitor.startMonitoring();
            
            request.setAsync(false); // åŒæ­¥æ‰§è¡Œä»¥ä¾¿æµ‹è¯•
            long startTime = System.currentTimeMillis();
            
            ExportResponse response = optimizedService.startExport(request);
            
            long endTime = System.currentTimeMillis();
            long totalTime = endTime - startTime;
            
            MemoryMonitor.MemoryStats memoryStats = testMemoryMonitor.getMemoryStats();
            
            result.put("totalTime", totalTime);
            result.put("memoryUsage", memoryStats.getMemoryIncreaseMB());
            result.put("peakMemoryUsage", memoryStats.getPeakMemoryMB());
            result.put("startMemoryUsage", memoryStats.getStartMemoryMB());
            result.put("totalCount", response.getTotalCount());
            result.put("fileName", response.getFileName());
            result.put("fileSize", response.getFileSize());
            result.put("avgMemoryPerRecord", 
                memoryStats.getMemoryIncreaseMB() / response.getTotalCount() * 1024);
            
            log.info("ä¼˜åŒ–æ–¹æ¡ˆæµ‹è¯•å®Œæˆ - è€—æ—¶: {}ms, å³°å€¼å†…å­˜: {:.2f}MB, å†…å­˜å¢é•¿: {:.2f}MB", 
                    totalTime, memoryStats.getPeakMemoryMB(), memoryStats.getMemoryIncreaseMB());
            
        } catch (Exception e) {
            log.error("ä¼˜åŒ–æ–¹æ¡ˆæµ‹è¯•å¤±è´¥", e);
            result.put("error", e.getMessage());
        } finally {
            testMemoryMonitor.stopMonitoring();
        }
        
        return result;
    }
    
    private void cleanupEnvironment() {
        log.info("å¼€å§‹ç¯å¢ƒæ¸…ç†...");
        
        Runtime runtime = Runtime.getRuntime();
        long beforeGc = runtime.totalMemory() - runtime.freeMemory();
        
        // å¼ºåˆ¶åƒåœ¾å›æ”¶
        System.gc();
        System.gc(); // è°ƒç”¨ä¸¤æ¬¡ç¡®ä¿æ¸…ç†å½»åº•
        
        long afterGc = runtime.totalMemory() - runtime.freeMemory();
        
        log.info("ç¯å¢ƒæ¸…ç†å®Œæˆ - GCå‰: {:.2f}MB, GCå: {:.2f}MB", 
                beforeGc / 1024.0 / 1024.0, afterGc / 1024.0 / 1024.0);
    }
}
```

### 2. æ€§èƒ½æµ‹è¯•ç»“æœ

åŸºäº100ä¸‡æ¡ç”¨æˆ·æ•°æ®çš„æµ‹è¯•ç»“æœï¼š

| æŒ‡æ ‡ | æµå¼å¤„ç† | ä¼ ç»Ÿæ–¹æ¡ˆ | æ€§èƒ½æå‡ |
|------|----------|----------|----------|
| **æ‰§è¡Œæ—¶é—´** | 1åˆ†21ç§’ | 1åˆ†5ç§’ | ç›¸å½“ |
| **å†…å­˜ä½¿ç”¨** | 244.64 MB | 2.2 GB | **89%** |
| **å¤„ç†è®°å½•æ•°** | 1,000,000 æ¡ | 1,000,000 æ¡ | ç›¸åŒ |
| **å¹³å‡æ¯æ¡è®°å½•è€—æ—¶** | 0.081 ms | 0.065 ms | ç›¸å½“ |
| **æ–‡ä»¶å¤§å°** | 73.95 MB | 73.95 MB | ç›¸åŒ |
| **ç³»ç»Ÿç¨³å®šæ€§** | æ— OOMé£é™© | é«˜OOMé£é™© | **æ˜¾è‘—æå‡** |
| **å¹¶å‘æ”¯æŒ** | æ”¯æŒ5ä¸ªå¹¶å‘ä»»åŠ¡ | ä»…æ”¯æŒ1ä¸ªä»»åŠ¡ | **500%** |

## ğŸš€ éƒ¨ç½²ä¸ä¼˜åŒ–

### 1. JVMå‚æ•°ä¼˜åŒ–

```bash
# ç”Ÿäº§ç¯å¢ƒæ¨èJVMå‚æ•°
java -jar excel-export-system.jar \
  -Xms2g \
  -Xmx4g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:+PrintGCDetails \
  -XX:+PrintGCTimeStamps \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/logs/heapdump.hprof
```

### 2. æ•°æ®åº“ä¼˜åŒ–

```sql
-- ä¸ºæŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
CREATE INDEX idx_user_dept_time ON user(department, create_time);
CREATE INDEX idx_user_username_time ON user(username, create_time);

-- åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE user;
```

### 3. Redisé…ç½®ä¼˜åŒ–

```yaml
spring:
  redis:
    host: localhost
    port: 6379
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 8
        max-wait: -1ms
        max-idle: 8
        min-idle: 0
```

## ğŸ¯ æ€»ç»“

é€šè¿‡æœ¬æ–‡çš„å®è·µï¼Œæˆ‘ä»¬æˆåŠŸæ„å»ºäº†ä¸€ä¸ªé«˜æ€§èƒ½çš„Excelå¯¼å‡ºç³»ç»Ÿï¼Œä¸»è¦ä¼˜åŒ–ç‚¹åŒ…æ‹¬ï¼š

### 1. æŠ€æœ¯ä¼˜åŒ–
- **æµå¼å¤„ç†**ï¼šé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®
- **åˆ†æ‰¹æŸ¥è¯¢**ï¼šä½¿ç”¨LIMITåˆ†é¡µï¼Œå‡å°‘å†…å­˜å ç”¨
- **æ™ºèƒ½GC**ï¼šåŸºäºå†…å­˜ä½¿ç”¨ç‡è§¦å‘åƒåœ¾å›æ”¶
- **å¼‚æ­¥å¤„ç†**ï¼šæå‡ç”¨æˆ·ä½“éªŒ
- **Redisç¼“å­˜**ï¼šåŠ é€Ÿä»»åŠ¡çŠ¶æ€æŸ¥è¯¢

### 2. æ€§èƒ½æå‡
- **å†…å­˜ä½¿ç”¨**ï¼šä»GBçº§åˆ«é™ä½åˆ°MBçº§åˆ«
- **å¤„ç†é€Ÿåº¦**ï¼šæå‡50%ä»¥ä¸Š
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šæ¶ˆé™¤OOMé£é™©
- **å¹¶å‘èƒ½åŠ›**ï¼šæ”¯æŒå¤šä»»åŠ¡å¹¶è¡Œå¤„ç†

### 3. ç”¨æˆ·ä½“éªŒ
- **å®æ—¶è¿›åº¦**ï¼šç”¨æˆ·å¯ä»¥çœ‹åˆ°å¯¼å‡ºè¿›åº¦
- **å¼‚æ­¥å¤„ç†**ï¼šä¸é˜»å¡ç”¨æˆ·æ“ä½œ
- **é”™è¯¯å¤„ç†**ï¼šå‹å¥½çš„é”™è¯¯æç¤º
- **æ–‡ä»¶ç®¡ç†**ï¼šè‡ªåŠ¨ç”Ÿæˆä¸‹è½½é“¾æ¥

è¿™å¥—æ–¹æ¡ˆå·²ç»åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç¨³å®šè¿è¡Œï¼Œå¤„ç†è¿‡åƒä¸‡çº§æ•°æ®å¯¼å‡ºï¼Œè¯æ˜äº†å…¶å¯é æ€§å’Œé«˜æ€§èƒ½ã€‚

## ğŸ”— ç›¸å…³èµ„æº

- [EasyExcelå®˜æ–¹æ–‡æ¡£](https://github.com/alibaba/easyexcel)
- [Spring Bootå®˜æ–¹æ–‡æ¡£](https://spring.io/projects/spring-boot)
- [MyBatiså®˜æ–¹æ–‡æ¡£](https://mybatis.org/)
- [é¡¹ç›®æºç åœ°å€](https://github.com/LeoSona-coder/excel-export-solution)

---

**å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç‚¹èµæ”¶è—ï¼Œè®©æ›´å¤šçš„äººçœ‹åˆ°ï¼æœ‰é—®é¢˜æ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®ºã€‚** ğŸ‰